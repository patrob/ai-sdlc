name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
    paths-ignore:
      - '**/*.md'
      - '.ai-sdlc/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.ai-sdlc/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run build
      - run: npm test
      - run: npm run test:integration

  publish-alpha:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Get next alpha version
        id: version
        run: |
          # Get base version from package.json (source of truth)
          BASE=$(node -p "require('./package.json').version")
          echo "Base version from package.json: ${BASE}"

          # Get all published versions and find the highest alpha for this base
          ALPHAS=$(npm view ai-sdlc versions --json 2>/dev/null | grep "\"${BASE}-alpha\." | sed 's/[", ]//g' || echo "")
          echo "Existing alphas for ${BASE}: ${ALPHAS}"

          if [ -z "$ALPHAS" ]; then
            # No alphas for this base version yet, start at 1
            NEXT_ALPHA=1
          else
            # Find the highest alpha number
            HIGHEST=$(echo "$ALPHAS" | sed -n 's/.*alpha\.\([0-9]*\).*/\1/p' | sort -n | tail -1)
            NEXT_ALPHA=$((HIGHEST + 1))
          fi

          NEXT_VERSION="${BASE}-alpha.${NEXT_ALPHA}"
          echo "Next version: ${NEXT_VERSION}"
          echo "version=${NEXT_VERSION}" >> $GITHUB_OUTPUT

      - name: Set version in package.json
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: npm publish --provenance --access public --tag alpha

  publish-stable:
    # Skip alpha tags - alpha versions are auto-published by publish-alpha on push to main
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-alpha')
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION}"

          # Determine npm tag based on version type (alpha tags are handled by publish-alpha job)
          if [[ "$VERSION" == *"-beta"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-rc"* ]]; then
            echo "tag=rc" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Set version in package.json
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Publish to npm
        run: npm publish --provenance --access public --tag ${{ steps.version.outputs.tag }}

      - name: Create GitHub Release
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
