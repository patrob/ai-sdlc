name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
    paths-ignore:
      - '**/*.md'
      - '.ai-sdlc/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.ai-sdlc/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run build
      - run: npm test
      - run: npm run test:integration

  publish-alpha:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Get next alpha version
        id: version
        run: |
          # Get the latest alpha version from npm, default to 0.0.0-alpha.0 if none exists
          LATEST=$(npm view ai-sdlc@alpha version 2>/dev/null || echo "0.0.0-alpha.0")
          echo "Latest alpha: ${LATEST}"

          # Extract base version and alpha number
          # Format: X.Y.Z-alpha.N
          BASE=$(echo "${LATEST}" | sed 's/-alpha.*//')
          ALPHA_NUM=$(echo "${LATEST}" | sed -n 's/.*alpha\.\([0-9]*\).*/\1/p')
          ALPHA_NUM=${ALPHA_NUM:-0}

          # Increment alpha number
          NEXT_ALPHA=$((ALPHA_NUM + 1))
          NEXT_VERSION="${BASE}-alpha.${NEXT_ALPHA}"

          echo "Next version: ${NEXT_VERSION}"
          echo "version=${NEXT_VERSION}" >> $GITHUB_OUTPUT

      - name: Set version in package.json
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: npm publish --provenance --access public --tag alpha

  publish-stable:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION}"

          # Determine npm tag based on version type
          if [[ "$VERSION" == *"-beta"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-rc"* ]]; then
            echo "tag=rc" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Set version in package.json
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: npm publish --provenance --access public --tag ${{ steps.version.outputs.tag }}

      - name: Create GitHub Release
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
